<!DOCTYPE html>
<html>
<head>
  <title>Election Survey System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef2f3;
      padding: 20px;
    }

    .box {
      background: white;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #aaa;
      font-size: 15px;
    }

    button {
      background: #2b7cff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    button.red {
      background: #d43b3b;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #999;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #f0f0f0;
    }
  </style>
</head>
<body>

<script>
/* âœ… PASTE YOUR NEW WEB APP URL HERE */
const LIVE_URL = "https://script.google.com/macros/s/AKfycbxsiECJkDUscrGRW5lp579YZZTYgpomb-mNR2s6Pt6XzhNy86EH0ogu9WLM5AByWwrkqw/exec";

let currentSheetId = "";
let autoSL = 1;
</script>

<!-- ================= DASHBOARD ================= -->
<div class="box" id="dashboard">
  <h2>Cluster Dashboard</h2>

  <button onclick="loadFiles()">Load Existing Files</button>
  <select id="fileList"></select>
  <button onclick="selectFile()">Open Selected File</button>

  <hr>

  <input id="newCluster" placeholder="New Cluster Name">
  <button onclick="createNewCluster()">Create New File</button>

  <hr>
  <button onclick="openFilter()">Advanced Filter</button>
</div>

<!-- ================= FAMILY ENTRY ================= -->
<div class="box" id="familyBox" style="display:none;">
  <h2>Family Entry</h2>

  <label>House Name</label>
  <input id="house">

  <label>Eligible Members</label>
  <input type="number" id="count" onchange="createMembers()">

  <label>SL No</label>
  <input id="slno" readonly>

  <div id="members"></div>

  <button onclick="saveFamily()">Save Family</button>
  <button class="red" onclick="backToDashboard()">Back</button>
</div>

<!-- ================= FILTER ================= -->
<div class="box" id="filterBox" style="display:none;">
  <h2>Filter & Summary</h2>

  <select id="fActive">
    <option value="">All Status</option>
    <option>Active</option>
    <option>Not Active</option>
  </select>

  <select id="fParty">
    <option value="">All Party</option>
    <option>NDA</option>
    <option>UDF</option>
    <option>LDF</option>
    <option>OTH</option>
  </select>

  <select id="fReligion">
    <option value="">All Religion</option>
    <option>Hindu</option>
    <option>Muslim</option>
    <option>Christian</option>
    <option>Others</option>
  </select>

  <input id="fBook" placeholder="Book No (optional)">
  <input id="fSerial" placeholder="Serial No (optional)">

  <button onclick="applyFilter()">Apply Filter</button>
  <button onclick="openExcel()">View in Excel</button>
  <button onclick="downloadCSV()">Download Excel</button>
  <button class="red" onclick="backToDashboard()">Back</button>

  <div id="filterSummary" style="margin-top:10px;font-weight:bold;"></div>
  <div id="filterResults"></div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
function showPage(id) {
  dashboard.style.display = "none";
  familyBox.style.display = "none";
  filterBox.style.display = "none";
  document.getElementById(id).style.display = "block";
}

function backToDashboard() {
  showPage("dashboard");
}

async function loadFiles() {
  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({ mode: "listFiles" })
  });

  let data = await res.json();
  let list = document.getElementById("fileList");
  list.innerHTML = "";

  data.files.forEach(f => {
    let opt = document.createElement("option");
    opt.value = f.id;
    opt.textContent = f.name;
    list.appendChild(opt);
  });
}

async function selectFile() {
  currentSheetId = document.getElementById("fileList").value;
  if (!currentSheetId) return alert("Select a file");

  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({ mode: "getLastSL", sheetId: currentSheetId })
  });

  let data = await res.json();
  autoSL = Number(data.lastSL) + 1;
  document.getElementById("slno").value = autoSL;
  showPage("familyBox");
}

async function createNewCluster() {
  let name = document.getElementById("newCluster").value.trim();
  if (!name) return alert("Enter cluster name");

  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({
      mode: "createFile",
      clusterName: name
    })
  });

  let data = await res.json();

  if (data.status === "EXISTS") return alert("File already exists");

  currentSheetId = data.sheetId;
  autoSL = 1;
  document.getElementById("slno").value = autoSL;
  showPage("familyBox");
}

function createMembers() {
  let count = Number(document.getElementById("count").value);
  let box = document.getElementById("members");
  box.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    box.innerHTML += `
      <h4>Member ${i}</h4>
      <input placeholder="Name">
      <input placeholder="Book No">
      <input placeholder="Serial No">

      <select>
        <option>Hindu</option>
        <option>Muslim</option>
        <option>Christian</option>
        <option>Others</option>
      </select>

      <select>
        <option>NDA</option>
        <option>UDF</option>
        <option>LDF</option>
        <option>OTH</option>
      </select>

      <select>
        <option>Active</option>
        <option>Not Active</option>
      </select>
      <hr>
    `;
  }
}

async function saveFamily() {
  let house = document.getElementById("house").value;
  let count = Number(document.getElementById("count").value);

  let inputs = document.querySelectorAll("#members input");
  let selects = document.querySelectorAll("#members select");

  let s = 0;

  for (let i = 0; i < inputs.length; i += 3) {
    await fetch(LIVE_URL, {
      method: "POST",
      body: JSON.stringify({
        sheetId: currentSheetId,
        slno: autoSL,
        house: house,
        count: count,
        name: inputs[i].value,
        book: inputs[i + 1].value,
        serial: inputs[i + 2].value,
        religion: selects[s * 3].value,
        party: selects[s * 3 + 1].value,
        active: selects[s * 3 + 2].value,
        showMain: s === 0
      })
    });
    s++;
  }

  autoSL++;
  document.getElementById("slno").value = autoSL;
  document.getElementById("members").innerHTML = "";
  document.getElementById("count").value = "";
  document.getElementById("house").value = "";

  alert("Saved Successfully");
}

function openFilter() {
  showPage("filterBox");
}

async function applyFilter() {
  let filters = {
    active: fActive.value,
    party: fParty.value,
    religion: fReligion.value,
    book: fBook.value.trim(),
    serial: fSerial.value.trim()
  };

  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({
      mode: "filter",
      sheetId: currentSheetId,
      filters: filters
    })
  });

  let data = await res.json();

  filterSummary.innerHTML = `
    Total: ${data.summary.total} |
    Active: ${data.summary.active} |
    Not Active: ${data.summary.notActive} |
    NDA: ${data.summary.party.NDA},
    UDF: ${data.summary.party.UDF},
    LDF: ${data.summary.party.LDF},
    OTH: ${data.summary.party.OTH}
  `;

  let html = `<table>
  <tr>
    <th>SL</th><th>House</th><th>Name</th>
    <th>Book</th><th>Serial</th>
    <th>Religion</th><th>Party</th><th>Status</th>
  </tr>`;

  data.data.forEach(r => {
    html += `<tr>
      <td>${r.slno}</td>
      <td>${r.house}</td>
      <td>${r.name}</td>
      <td>${r.book}</td>
      <td>${r.serial}</td>
      <td>${r.religion}</td>
      <td>${r.party}</td>
      <td>${r.active}</td>
    </tr>`;
  });

  html += "</table>";
  filterResults.innerHTML = html;
}

function openExcel() {
  window.open(
    "https://docs.google.com/spreadsheets/d/" + currentSheetId,
    "_blank"
  );
}

function downloadCSV() {
  window.open(
    "https://docs.google.com/spreadsheets/d/" +
    currentSheetId +
    "/export?format=csv",
    "_blank"
  );
}
</script>

</body>
</html>
