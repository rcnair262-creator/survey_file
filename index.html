<!DOCTYPE html>
<html>
<head>
  <title>Election Survey System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/sanscript@1.2.2/sanscript.min.js"></script>

  <style>
    body { font-family: Arial; background: #eef2f3; padding: 20px; }
    .box { background: #fff; padding: 20px; max-width: 1000px; margin: auto; border-radius: 10px; }
    input, select, button { width: 100%; padding: 10px; margin: 7px 0; }
    button { background: #2b7cff; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button.red { background: #d43b3b; }
    hr { border: 1px dashed #aaa; margin: 10px 0; }

    table { width: 100%; border-collapse: collapse; }
    table, th, td { border: 1px solid #999; }
    th, td { padding: 7px; text-align: center; }
    th { background: #eee; }
  </style>
</head>
<body>

<div class="box" id="dashboard">
  <h2>Cluster Dashboard</h2>

  <button onclick="loadFiles()">üîÑ Load Existing Files</button>
  <select id="fileList"></select>
  <button onclick="selectFile()">‚úÖ Open Selected File</button>

  <hr>

  <h3>Create New Cluster</h3>
  <input id="newCluster" placeholder="Cluster Name">
  <button onclick="createNewCluster()">‚ûï Create New File</button>

  <hr>

  <button onclick="openFilter()">üîé Advanced Filter</button>
</div>

<div class="box" id="familyBox" style="display:none;">

  <h2>Family Entry</h2>

  <label>House Name</label>
  <input id="house">

  <label>Eligible Members</label>
  <input type="number" id="count" onchange="createMembers()">

  <label>SL No</label>
  <input id="slno" readonly>

  <div id="members"></div>

  <button onclick="saveFamily()">üíæ Save Family</button>
  <button class="red" onclick="backToDashboard()">‚¨Ö Back</button>

</div>

<div class="box" id="filterBox" style="display:none;">
  <h2>Advanced Filter</h2>

  <input id="fHouse" placeholder="House (optional)">

  <select id="fReligion">
    <option value="">Any Religion</option>
    <option>Hindu</option>
    <option>Muslim</option>
    <option>Christian</option>
    <option>Others</option>
  </select>

  <select id="fParty">
    <option value="">Any Party</option>
    <option>NDA</option>
    <option>UDF</option>
    <option>LDF</option>
    <option>OTH</option>
  </select>

  <select id="fActive">
    <option value="">Any Status</option>
    <option>Active</option>
    <option>Not Active</option>
  </select>

  <button onclick="applyFilter()">üîç Apply Filter</button>
  <button class="red" onclick="backToDashboard()">‚¨Ö Back</button>

  <hr>
  <div id="filterResults"></div>
</div>

<script>
const LIVE_URL = "https://script.google.com/macros/s/AKfycbwOTke0ecgM4IY2BpL1lVXq1sSAFtyHmelZROpigysxuac4xEpva31c22IzwAjnE-s8/exec";

let currentSheetId = "";
let autoSL = 1;

/* ================= LOAD FILES ================= */
async function loadFiles() {
  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({ mode: "listFiles" })
  });

  let data = await res.json();
  let list = document.getElementById("fileList");
  list.innerHTML = "";

  data.files.forEach(f => {
    let opt = document.createElement("option");
    opt.value = f.id;
    opt.text = f.name;
    list.appendChild(opt);
  });

  alert("Files loaded");
}

/* ================= SELECT FILE ================= */
async function selectFile() {
  let list = document.getElementById("fileList");
  if (!list.value) return alert("Select a file");

  currentSheetId = list.value;

  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({
      mode: "getLastSL",
      sheetId: currentSheetId
    })
  });

  let data = await res.json();
  autoSL = Number(data.lastSL) + 1;

  document.getElementById("slno").value = autoSL;

  document.getElementById("dashboard").style.display = "none";
  document.getElementById("familyBox").style.display = "block";
}

/* ================= CREATE FILE ================= */
async function createNewCluster() {

  let name = document.getElementById("newCluster").value.trim();
  if (!name) return alert("Enter cluster name");

  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({
      mode: "createFile",
      clusterName: name
    })
  });

  let data = await res.json();

  if (data.status === "EXISTS") {
    alert("File already exists. Open it instead.");
    return;
  }

  currentSheetId = data.sheetId;
  autoSL = 1;
  document.getElementById("slno").value = autoSL;

  document.getElementById("dashboard").style.display = "none";
  document.getElementById("familyBox").style.display = "block";
}

/* ================= CREATE MEMBERS ================= */
function createMembers() {
  let count = document.getElementById("count").value;
  let box = document.getElementById("members");
  box.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    box.innerHTML += `
      <h4>Member ${i}</h4>
      <input placeholder="Name">
      <input placeholder="Book No">
      <input placeholder="Serial No">

      <select><option>Hindu</option><option>Muslim</option><option>Christian</option><option>Others</option></select>
      <select><option>NDA</option><option>UDF</option><option>LDF</option><option>OTH</option></select>
      <select><option>Active</option><option>Not Active</option></select>
      <hr>
    `;
  }
}

/* ================= SAVE FAMILY ================= */
async function saveFamily() {

  let house = document.getElementById("house").value;
  let count = document.getElementById("count").value;
  let inputs = document.querySelectorAll("#members input");
  let selects = document.querySelectorAll("#members select");
  let s = 0;

  for (let i = 0; i < inputs.length; i += 3) {

    let res = await fetch(LIVE_URL, {
      method: "POST",
      body: JSON.stringify({
        sheetId: currentSheetId,
        slno: autoSL,
        house: house,
        count: count,
        name: inputs[i].value,
        book: inputs[i+1].value,
        serial: inputs[i+2].value,
        religion: selects[s*3].value,
        party: selects[s*3+1].value,
        active: selects[s*3+2].value,
        showMain: s === 0
      })
    });

    let data = await res.json();
    if (data.status !== "SAVED") return alert("Save failed! Check internet.");
    s++;
  }

  autoSL++;
  document.getElementById("slno").value = autoSL;

  document.getElementById("members").innerHTML = "";
  document.getElementById("count").value = "";
  document.getElementById("house").value = "";

  alert("Family saved ‚úÖ");
}

/* ================= FILTER ================= */
function openFilter() {
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("filterBox").style.display = "block";
}

async function applyFilter() {

  let filters = {
    house: document.getElementById("fHouse").value.trim(),
    religion: document.getElementById("fReligion").value,
    party: document.getElementById("fParty").value,
    active: document.getElementById("fActive").value
  };

  let res = await fetch(LIVE_URL, {
    method: "POST",
    body: JSON.stringify({
      mode: "filter",
      sheetId: currentSheetId,
      filters: filters
    })
  });

  let data = await res.json();
  let box = document.getElementById("filterResults");

  if (!data.data || data.data.length === 0) {
    box.innerHTML = "<p>No records found.</p>";
    return;
  }

  let html = `
    <h3>Total Results: ${data.data.length}</h3>
    <table>
      <tr>
        <th>SL</th><th>House</th><th>Name</th><th>Book</th>
        <th>Serial</th><th>Religion</th><th>Party</th><th>Status</th>
      </tr>
  `;

  data.data.forEach(r => {
    html += `
      <tr>
        <td>${r.slno || ""}</td>
        <td>${r.house || ""}</td>
        <td>${r.name}</td>
        <td>${r.book}</td>
        <td>${r.serial}</td>
        <td>${r.religion}</td>
        <td>${r.party}</td>
        <td>${r.active}</td>
      </tr>
    `;
  });

  html += "</table>";
  box.innerHTML = html;
}

/* ================= BACK ================= */
function backToDashboard() {
  document.getElementById("familyBox").style.display = "none";
  document.getElementById("filterBox").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
}
</script>

</body>
</html>

